# Terminate specfile builds on unrecognized or unsupported OS to avoid
# unexpected errors. This is easily overridden by setting the appropriate
# macro (rhel, sle_version) on the rpmbuild command line.
# For example, if using Fedora 20 to 27, "--define rhel 7"
%if %{?rhel:1} && %{?rhel} < 7
%{error: "Detected operating system RHEL %{rhel} is not supported."}
%else
%if %{?sle_version:1} && %{?sle_version} < 120100
%{error: "Detected operating system SLE %{sle_version} is not supported."}
%else
%{error: "Detected operating system is not supported."}
%endif # sle_version
%endif # rhel

%{!?_rel:%{expand:%%global _rel 0.%(test "@GITVERSION@" != "0000" && echo "@GITVERSION@" || git show -s --pretty=format:%h || echo 0000)}}
%define debug_package %{nil}
%define wwstatedir @LOCAL_STATE_DIR@

Name: warewulf-common
Summary: Scalable systems management suite for high performance clusters
Version: @PACKAGE_VERSION@
Release: %{_rel}%{?dist}
License: US Dept. of Energy (BSD-like)
Source: %{name}-%{version}.tar.gz
ExclusiveOS: linux
Conflicts: warewulf < 3
BuildArch: noarch
BuildRequires: autoconf, automake
Requires: perl(DBD::MySQL) perl(DBD::Pg) perl(DBD::SQLite) perl(JSON::PP)

%if %{?rhel:1}
%global sql_name mariadb
%global daemon_name mariadb
%else
%global sql_name mysql
%global daemon_name mysqld
%endif

Requires: %sql_name

%description
Warewulf is a operating system management toolkit designed to facilitate
large scale deployments of systems on physical, virtual and cloud-based
infrastructures. It facilitates elastic and large deployments consisting
of groups of homogenous systems.

Warewulf Common contains the core functionality of Warewulf. It provides
the base libraries that are shared and utilized by the other Warewulf
modules as well as the backend data store interface, event and trigger
handlers and a basic command line interface.


%prep
%setup -q


%build
%configure --localstatedir=%{wwstatedir}
%{__make} %{?mflags}


%install
%{__make} install DESTDIR=$RPM_BUILD_ROOT %{?mflags_install}


%pre
/usr/sbin/groupadd -r warewulf >/dev/null 2>&1 || :


%post
if [ $1 -eq 2 ] ; then
    %{_bindir}/wwsh object canonicalize -t node >/dev/null 2>&1 || :
    %{_bindir}/wwsh object canonicalize -t file >/dev/null 2>&1 || :
fi
%systemd_post %{daemon_name}.service

%postun
%systemd_postun_with_restart %{daemon_name}.service


%files
%defattr(-, root, root)
%doc AUTHORS ChangeLog INSTALL NEWS README TODO
%license COPYING LICENSE
%attr(0755, root, warewulf) %dir %{_sysconfdir}/warewulf/
%attr(0755, root, warewulf) %dir %{_sysconfdir}/warewulf/defaults/
%attr(0444, root, warewulf) %{_libexecdir}/warewulf/wwinit/functions
%attr(0644, root, root) %{_sysconfdir}/bash_completion.d/warewulf_completion
%attr(0644, root, warewulf) %config(noreplace) %{_sysconfdir}/warewulf/database.conf
%attr(0640, root, warewulf) %config(noreplace) %{_sysconfdir}/warewulf/database-root.conf
%attr(0644, root, warewulf) %config(noreplace) %{_sysconfdir}/warewulf/defaults/node.conf
%{_mandir}/*
%{_bindir}/*
%{_datadir}/warewulf/
%{_libexecdir}/warewulf/wwinit
%{perl_vendorlib}/*

# ====================
%package localdb
Summary: Warewulf - Install local database server
Requires: %{name} = %{version}-%{release}
BuildRequires: systemd-rpm-macros
Requires: %{sql_name}-server

%description localdb
Warewulf is a operating system management toolkit designed to facilitate
large scale deployments of systems on physical, virtual and cloud-based
infrastructures. It facilitates elastic and large deployments consisting
of groups of homogenous systems.

This metapackage installs a local MySQL or MariaDB instance. It is not
required for installs that will use an external database server.

%post localdb
%systemd_post %{daemon_name}.service

%preun localdb
%systemd_preun_with_restart %{daemon_name}.service

%files localdb
%defattr(-, root, root)


# ====================
%changelog
